# bots/trendyolDetay.py

from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.common.by import By
from bs4 import BeautifulSoup
from datetime import datetime
import os
import time
import traceback
import logging
from db_connection import get_db_connection

# === Loglama ayarlarƒ± ===
base_dir = os.path.dirname(os.path.abspath(__file__))
log_dir = os.path.join(base_dir, "..", "bot_logs")
os.makedirs(log_dir, exist_ok=True)

log_path = os.path.join(log_dir, "trendyol-detail_latest.log")

logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s - %(levelname)s - %(message)s",
    handlers=[
        logging.FileHandler(log_path, mode='w', encoding="utf-8"),
        logging.StreamHandler()
    ]
)

logger = logging.getLogger(__name__)

# === PostgreSQL baƒülantƒ±sƒ± ===
try:
    conn = get_db_connection()
    cursor = conn.cursor()
    logger.info("‚úÖ Veritabanƒ± baƒülantƒ±sƒ± ba≈üarƒ±lƒ±")
except Exception as e:
    logger.error(f"‚ùå Veritabanƒ± baƒülantƒ± hatasƒ±: {e}")
    raise

# ƒ∞statistikleri takip et
processed_count = 0
error_count = 0
error_products = []

# === Selenium Ayarlarƒ± ===
try:
    chrome_options = Options()
    chrome_options.add_argument("--headless")
    chrome_options.add_argument("--disable-gpu")
    chrome_options.add_argument("--no-sandbox")
    chrome_options.add_argument("--disable-dev-shm-usage")
    chrome_options.add_argument("--window-size=1920,1080")
    chrome_options.add_argument(
        "user-agent=Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/115.0.0.0 Safari/537.36"
    )
    
    driver = webdriver.Chrome(service=Service("/usr/bin/chromedriver"), options=chrome_options)
    wait = WebDriverWait(driver, 15)
    logger.info("‚úÖ Chrome driver ba≈ülatƒ±ldƒ±")
except Exception as e:
    logger.error(f"‚ùå Chrome driver ba≈ülatma hatasƒ±: {e}")
    raise

try:
    # Detayƒ± alƒ±nmamƒ±≈ü √ºr√ºnleri √ßek
    cursor.execute("""
        SELECT id, product_link 
        FROM products 
        WHERE platform = 'trendyol' 
        AND product_link IS NOT NULL
        AND NOT EXISTS (
            SELECT 1 FROM product_details WHERE product_details.product_id = products.id
        )
        ORDER BY created_at DESC
    """)
    urunler = cursor.fetchall()
    total_products = len(urunler)
    
    logger.info(f"üìä Toplam {total_products} √ºr√ºn bulundu")

    if not urunler:
        logger.warning("‚ö†Ô∏è ƒ∞≈ülenecek √ºr√ºn bulunamadƒ±")
    else:
        for index, row in enumerate(urunler, 1):
            # RealDictRow kontrol√º
            if isinstance(row, dict):
                product_id = row.get("id")
                url = row.get("product_link")
            elif isinstance(row, (list, tuple)) and len(row) == 2:
                product_id, url = row
            else:
                logger.warning(f"‚ö†Ô∏è Beklenmeyen veri yapƒ±sƒ±: {row}")
                continue

            if not url or not isinstance(url, str) or not url.startswith("http"):
                logger.warning(f"‚ùå Ge√ßersiz URL atlandƒ± ‚Üí Product ID: {product_id}, URL: {url}")
                continue

            logger.info(f"\n{'='*60}")
            logger.info(f"üîç ƒ∞≈üleniyor [{index}/{total_products}]: Product ID {product_id}")
            logger.info(f"üìå URL: {url}")

            try:
                driver.get(url)
                logger.info("‚è≥ Sayfa y√ºkleniyor...")
                
                # Sayfanƒ±n y√ºklenmesini bekle
                wait.until(EC.presence_of_element_located((By.TAG_NAME, "body")))
                time.sleep(3)

                soup = BeautifulSoup(driver.page_source, "html.parser")
                logger.info("‚úÖ Sayfa ba≈üarƒ±yla y√ºklendi")

                # === A√ßƒ±klama ===
                description_items = soup.select("ul.content-descriptions-description-content li")
                description = " ".join([li.get_text(strip=True) for li in description_items]) if description_items else None
                logger.info(f"üìù A√ßƒ±klama: {'Bulundu' if description else 'Bulunamadƒ±'}")

                # === Maƒüaza Adƒ± ===
                store_name_tag = soup.select_one("div.merchant-name")
                store_name = store_name_tag.get_text(strip=True) if store_name_tag else None
                logger.info(f"üè™ Maƒüaza: {store_name or 'Bulunamadƒ±'}")

                # === Kargo Bilgileri ===                
                shipping_tag = soup.select_one("div.delivery-container")
                shipping_info = shipping_tag.get_text(" ", strip=True) if shipping_tag else None
                free_shipping = True
                logger.info(f"üöö Kargo: {shipping_info or 'Bulunamadƒ±'}")

                # === √úr√ºn Puanƒ± ===
                rating = 0.0
                rating_tag = soup.select_one("span.reviews-summary-average-rating")
                if rating_tag:
                    try:
                        rating = float(rating_tag.get_text(strip=True).replace(",", "."))
                        logger.info(f"‚≠ê √úr√ºn puanƒ±: {rating}")
                    except Exception as e:
                        logger.warning(f"‚ö†Ô∏è √úr√ºn puanƒ± parse edilemedi: {e}")

                # === √úr√ºn Tipi (Kategori) ===
                product_type = None
                breadcrumb_items = soup.select("ul.breadcrumb-list li.product-detail-new-breadcrumbs-item a")
                if len(breadcrumb_items) >= 2:
                    product_type = breadcrumb_items[-2].get_text(strip=True)
                    logger.info(f"üè∑Ô∏è Kategori: {product_type}")
                else:
                    logger.warning("‚ö†Ô∏è Kategori bulunamadƒ±")

                # === G√∂rsel URL ===
                image_url = None
                image_selectors = [
                    'img[data-testid="image"]',
                    '.gallery-modal-content img',
                    '.product-slide-image img',
                    '.product-image-container img'
                ]
                
                for selector in image_selectors:
                    image_tag = soup.select_one(selector)
                    if image_tag:
                        image_url = image_tag.get("src") or image_tag.get("data-src")
                        if image_url:
                            logger.info(f"üñºÔ∏è G√∂rsel URL: {image_url}")
                            break
                
                if not image_url:
                    logger.warning("‚ö†Ô∏è G√∂rsel URL bulunamadƒ±")

                # === Maƒüaza Puanƒ± ===
                store_rating = 0.0
                store_rating_tag = soup.select_one("div.score-badge")
                if store_rating_tag:
                    try:
                        store_rating = float(store_rating_tag.get_text(strip=True).replace(",", "."))
                        logger.info(f"‚≠ê Maƒüaza puanƒ±: {store_rating}")
                    except Exception as e:
                        logger.warning(f"‚ö†Ô∏è Maƒüaza puanƒ± parse edilemedi: {e}")

                # === Veritabanƒ±na kaydet ===
                now = datetime.now()

                cursor.execute("""
                    INSERT INTO product_details 
                        (product_id, description, store_name, shipping_info, free_shipping, 
                         rating, product_type, created_at, updated_at, image_url, store_rating)
                    VALUES 
                        (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s)
                    ON CONFLICT (product_id) DO UPDATE SET
                        description = EXCLUDED.description,
                        store_name = EXCLUDED.store_name,
                        shipping_info = EXCLUDED.shipping_info,
                        free_shipping = EXCLUDED.free_shipping,
                        rating = EXCLUDED.rating,
                        product_type = EXCLUDED.product_type,
                        updated_at = NOW(),
                        image_url = EXCLUDED.image_url,
                        store_rating = EXCLUDED.store_rating;
                """, (product_id, description, store_name, shipping_info, free_shipping, 
                      rating, product_type, now, now, image_url, store_rating))

                # === √úr√ºn √∂zellikleri ===
                cursor.execute("DELETE FROM product_attributes WHERE product_id = %s", (product_id,))
                
                attribute_count = 0
                attribute_items = soup.select("div.attribute-item")
                
                # Tekrar eden √∂zellikleri √∂nlemek i√ßin set kullan
                processed_attributes = set()
                
                for attr in attribute_items:
                    name_div = attr.select_one("div.name")
                    value_div = attr.select_one("div.value")
                    if name_div and value_div:
                        attr_name = name_div.get_text(strip=True)
                        attr_value = value_div.get_text(strip=True)
                        
                        # Aynƒ± isimli √∂zellik daha √∂nce eklendiyse, atla
                        if attr_name in processed_attributes:
                            logger.warning(f"‚ö†Ô∏è Tekrar eden √∂zellik atlandƒ±: {attr_name}")
                            continue
                        
                        try:
                            cursor.execute("""
                                INSERT INTO product_attributes (product_id, attribute_name, attribute_value, created_at)
                                VALUES (%s, %s, %s, NOW())
                                ON CONFLICT (product_id, attribute_name) DO UPDATE
                                SET attribute_value = EXCLUDED.attribute_value,
                                    created_at = NOW()
                            """, (product_id, attr_name, attr_value))
                            processed_attributes.add(attr_name)
                            attribute_count += 1
                        except Exception as e:
                            logger.error(f"‚ùå √ñzellik eklenirken hata: {attr_name} - {e}")
                            continue

                logger.info(f"üìã {attribute_count} √∂zellik bulundu ve kaydedildi")

                conn.commit()
                processed_count += 1
                logger.info(f"‚úÖ Product ID {product_id} ba≈üarƒ±yla g√ºncellendi")

            except Exception as e:
                error_count += 1
                error_products.append({
                    'product_id': product_id,
                    'url': url,
                    'error': str(e)
                })
                logger.error(f"‚ùå Product ID {product_id} i≈ülenirken hata: {e}")
                logger.error(f"Stack trace:\n{traceback.format_exc()}")
                
                conn.rollback()
                
                # Kritik hata kontrol√º
                if "chrome not reachable" in str(e).lower():
                    logger.error("üö® Chrome eri≈üilemiyor, bot durduruluyor!")
                    break
                
                continue

except Exception as e:
    logger.error(f"üö® Genel hata: {e}")
    logger.error(f"Stack trace:\n{traceback.format_exc()}")

finally:
    # √ñzet rapor
    logger.info(f"\n{'='*60}")
    logger.info("üìä √ñZET RAPOR")
    logger.info(f"‚úÖ Ba≈üarƒ±yla i≈ülenen: {processed_count}")
    logger.info(f"‚ùå Hatalƒ±: {error_count}")
    logger.info(f"üìà Toplam: {processed_count + error_count}")
    
    if error_products:
        logger.info("\n‚ùå HATALI √úR√úNLER:")
        for error_product in error_products[:10]:
            logger.info(f"- Product ID: {error_product['product_id']}")
            logger.info(f"  URL: {error_product['url']}")
            logger.info(f"  Hata: {error_product['error']}")
    
    # Temizlik
    try:
        driver.quit()
        logger.info("‚úÖ Chrome driver kapatƒ±ldƒ±")
    except:
        logger.warning("‚ö†Ô∏è Chrome driver kapatƒ±lamadƒ±")
    
    try:
        cursor.close()
        conn.close()
        logger.info("‚úÖ Veritabanƒ± baƒülantƒ±sƒ± kapatƒ±ldƒ±")
    except:
        logger.warning("‚ö†Ô∏è Veritabanƒ± baƒülantƒ±sƒ± kapatƒ±lamadƒ±")
    
    logger.info(f"\nüéâ Trendyol detay botu tamamlandƒ±!")